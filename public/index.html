<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>Eyzaun Multi-User Avatar Chat</title>
    <link rel="icon" href="https://kick.com/favicon.ico" type="image/ico">
    <meta name="description" content="Her kullanÄ±cÄ±nÄ±n kendi avatarÄ±nÄ±n olduÄŸu interaktif chat sistemi">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1920px;
            height: 1080px;
            background: transparent;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            position: relative;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 12px;
            z-index: 10002;
            border: 2px solid #00ff00;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0,255,0,0.3);
        }

        /* Brand Header */
        .brand-header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff69b4, #00ff00, #00bfff, #ff69b4);
            background-size: 400% 400%;
            animation: gradientShift 4s ease infinite;
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            z-index: 10002;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Commands Help - Full Height */
        .commands-help {
            position: fixed;
            top: 20px;
            left: 20px;
            bottom: 250px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 20px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 10002;
            width: 380px;
            border: 3px solid #ff69b4;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .commands-help h3 {
            color: #ff69b4;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
        }

        .command-category {
            margin-bottom: 15px;
        }

        .command-category h4 {
            color: #00bfff;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .commands-help ul {
            list-style: none;
        }

        .commands-help li {
            margin: 4px 0;
            color: #00ff00;
            font-weight: 500;
            font-size: 11px;
        }

        .commands-help li::before {
            content: "â–¶ ";
            margin-right: 5px;
            color: #ff69b4;
        }

        /* User Avatar System */
        .user-avatar {
            position: fixed;
            width: 60px;
            height: 60px;
            font-size: 50px;
            z-index: 9998;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
        }

        .user-avatar.moving {
            transform: scale(1.1);
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.6));
        }

        .user-avatar.dancing {
            animation: avatarDance 1.5s ease-in-out infinite;
        }

        @keyframes avatarDance {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-8deg) scale(1.05); }
            50% { transform: rotate(8deg) scale(0.95); }
            75% { transform: rotate(-4deg) scale(1.05); }
        }

        .user-avatar.jumping {
            animation: avatarJump 1s ease-in-out;
        }

        @keyframes avatarJump {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.2); }
            100% { transform: translateY(0) scale(1); }
        }

        .user-avatar.spinning {
            animation: avatarSpin 1s ease-in-out;
        }

        @keyframes avatarSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.3); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* Speech Bubbles */
        .speech-bubble {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10001;
            max-width: 200px;
            word-wrap: break-word;
            border: 2px solid #00ff00;
            backdrop-filter: blur(10px);
            animation: bubbleAppear 0.3s ease-out;
        }

        .speech-bubble.command {
            border-color: #ff69b4;
            background: rgba(255,105,180,0.2);
            box-shadow: 0 0 15px rgba(255,105,180,0.4);
        }

        .speech-bubble.broadcaster {
            border-color: #ff69b4;
            background: rgba(255,105,180,0.3);
        }

        .speech-bubble.moderator {
            border-color: #00bfff;
            background: rgba(0,191,255,0.3);
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(0,0,0,0.9);
        }

        @keyframes bubbleAppear {
            0% { transform: scale(0) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* User Info Label */
        .user-label {
            position: fixed;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            z-index: 10000;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }

        .user-label.broadcaster {
            background: rgba(255,105,180,0.8);
        }

        .user-label.moderator {
            background: rgba(0,191,255,0.8);
        }

        .user-label.vip {
            background: rgba(255,215,0,0.8);
            color: black;
        }

        /* Minimized Effect Notification */
        .mini-effect-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(45deg, #ff69b4, #00ff00);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            z-index: 10003;
            animation: miniNotification 2s ease-out forwards;
            border: 1px solid white;
            backdrop-filter: blur(5px);
        }

        @keyframes miniNotification {
            0% { transform: translateX(300px); opacity: 0; }
            15% { transform: translateX(0); opacity: 1; }
            85% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(300px); opacity: 0; }
        }

        /* Stats Display - Smaller */
        .stats-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 10002;
            border: 2px solid #00ff00;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats-display h3 {
            color: #ff69b4;
            margin-bottom: 10px;
            font-size: 13px;
            text-align: center;
        }

        .stats-item {
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stats-value {
            color: #00ff00;
            font-weight: bold;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a, #1a1a1a);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10004;
            font-size: 24px;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #333;
            border-top: 6px solid #ff69b4;
            border-right: 6px solid #00ff00;
            border-bottom: 6px solid #00bfff;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Particles Container */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes particleFloat {
            0% { 
                transform: translateY(0) scale(1) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(-250px) scale(0.3) rotate(720deg); 
                opacity: 0; 
            }
        }

        /* Enhanced Animations */
        .screen-shake {
            animation: screenShake 1s ease-in-out;
        }

        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-15px) translateY(-5px); }
            20% { transform: translateX(15px) translateY(5px); }
            30% { transform: translateX(-15px) translateY(-5px); }
            40% { transform: translateX(15px) translateY(5px); }
            50% { transform: translateX(-8px) translateY(-3px); }
            60% { transform: translateX(8px) translateY(3px); }
            70% { transform: translateX(-8px) translateY(-3px); }
            80% { transform: translateX(8px) translateY(3px); }
            90% { transform: translateX(-3px) translateY(-1px); }
        }

        /* Lightning Flash */
        .lightning-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ffffff, #e6f3ff, #ffffff);
            z-index: 10000;
            pointer-events: none;
        }

        @keyframes lightningFlash {
            0% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0; }
            15% { opacity: 1; }
            25% { opacity: 0; }
            35% { opacity: 0.9; }
            45% { opacity: 0; }
            55% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* User Count Display */
        .user-count-display {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 10002;
            border: 2px solid #00bfff;
            backdrop-filter: blur(5px);
        }

        /* Custom Scrollbars */
        .commands-help::-webkit-scrollbar {
            width: 6px;
        }

        .commands-help::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .commands-help::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff69b4, #00ff00);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="spinner"></div>
        <div style="font-size: 32px; font-weight: bold;">EYZAUN MULTI-USER AVATAR SYSTEM</div>
        <div style="font-size: 18px; margin-top: 20px; color: #ff69b4;">Her kullanÄ±cÄ± kendi avatarÄ±nÄ± kontrol ediyor...</div>
        <div style="font-size: 16px; margin-top: 15px; color: #00ff00;">Kanal: <span id="channelName">eyzaun</span></div>
        <div style="font-size: 14px; margin-top: 10px; color: #00bfff;">Sistem: Multi-Avatar Interactive v3.0</div>
    </div>

    <!-- Brand Header -->
    <div class="brand-header">
        EYZAUN MULTI-USER AVATAR CHAT SYSTEM
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status">
        BaÄŸlantÄ± kuruluyor...
    </div>

    <!-- User Count Display -->
    <div id="userCountDisplay" class="user-count-display">
        Aktif Avatarlar: <span id="activeAvatars">0</span>
    </div>

    <!-- Commands Help -->
    <div class="commands-help">
        <h3>AVATAR KOMUTLARI</h3>
        
        <div class="command-category">
            <h4>ðŸš¶ Hareket</h4>
            <ul>
                <li>!saÄŸ - SaÄŸa git</li>
                <li>!sol - Sola git</li>
                <li>!yukarÄ± - YukarÄ± git</li>
                <li>!aÅŸaÄŸÄ± - AÅŸaÄŸÄ± git</li>
            </ul>
        </div>

        <div class="command-category">
            <h4>ðŸ’ƒ Animasyon</h4>
            <ul>
                <li>!dans - Dans et</li>
                <li>!zÄ±pla - ZÄ±pla</li>
                <li>!dÃ¶ndÃ¼r - DÃ¶n</li>
                <li>!karakter - Avatar deÄŸiÅŸtir</li>
            </ul>
        </div>

        <div class="command-category">
            <h4>ðŸŽ¬ Temel Efektler</h4>
            <ul>
                <li>!patlama - Mega patlama</li>
                <li>!yÄ±ldÄ±rÄ±m - ÅžimÅŸek Ã§akmasÄ±</li>
                <li>!kar - Kar yaÄŸÄ±ÅŸÄ±</li>
                <li>!ateÅŸ - AteÅŸ Ã§emberi</li>
                <li>!konfeti - Konfeti patlamasÄ±</li>
                <li>!kalp - Kalp yaÄŸmuru</li>
                <li>!rainbow - GÃ¶kkuÅŸaÄŸÄ±</li>
                <li>!shake - Ekran sarsÄ±ntÄ±sÄ±</li>
            </ul>
        </div>

        <div class="command-category">
            <h4>âš¡ GeliÅŸmiÅŸ Efektler</h4>
            <ul>
                <li>!lazer - Lazer gÃ¶sterisi</li>
                <li>!meteor - Meteor yaÄŸmuru</li>
                <li>!matrix - Matrix efekti</li>
                <li>!portal - Portal aÃ§ma</li>
                <li>!galaksi - Galaksi dÃ¶ndÃ¼rme</li>
                <li>!tsunami - Tsunami dalgasÄ±</li>
            </ul>
        </div>

        <div class="command-category">
            <h4>ðŸŽµ Ses Efektleri</h4>
            <ul>
                <li>!bas - Bass drop</li>
                <li>!davul - Davul Ã§alma</li>
                <li>!gitar - Gitar riffi</li>
                <li>!synth - Synthesizer</li>
            </ul>
        </div>

        <div class="command-category">
            <h4>ðŸŽ¯ Ã–zel Efektler</h4>
            <ul>
                <li>!nuke - NÃ¼kleer patlama</li>
                <li>!disco - Disco topu</li>
                <li>!ufo - UFO Ã§aÄŸÄ±rma</li>
                <li>!ninja - Ninja saldÄ±rÄ±sÄ±</li>
            </ul>
        </div>
    </div>

    <!-- Stats Display -->
    <div id="statsDisplay" class="stats-display">
        <h3>SÄ°STEM Ä°STATÄ°STÄ°KLERÄ°</h3>
        <div class="stats-item">
            <span>Toplam Mesaj:</span>
            <span class="stats-value" id="totalMessages">0</span>
        </div>
        <div class="stats-item">
            <span>Avatar SayÄ±sÄ±:</span>
            <span class="stats-value" id="totalAvatars">0</span>
        </div>
        <div class="stats-item">
            <span>Toplam Hareket:</span>
            <span class="stats-value" id="totalMoves">0</span>
        </div>
        <div class="stats-item">
            <span>WebSocket:</span>
            <span class="stats-value" id="websocketState">Disconnected</span>
        </div>
        <div class="stats-item">
            <span>Ã‡alÄ±ÅŸma SÃ¼resi:</span>
            <span class="stats-value" id="uptime">00:00</span>
        </div>
    </div>

    <!-- Particles Container -->
    <div id="particlesContainer" class="particles-container"></div>

    <script>
        // Kick WebSocket API
        class EyzaunKickWebSocketAPI {
            constructor(channelName = 'eyzaun') {
                this.channelName = channelName;
                this.chatroomId = null;
                this.channelId = null;
                this.websocket = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10;
                this.reconnectDelay = 2000;
                this.eventHandlers = new Map();
                this.messageCache = new Set();
                this.heartbeatInterval = null;
                this.lastPong = Date.now();
                
                this.pusherAppKey = '32cbd69e4b950bf97679';
                this.pusherCluster = 'us2';
                this.protocolVersion = 7;
                this.baseUrl = 'https://kick.com/api';
            }

            async connect() {
                try {
                    await this.getChannelInfo();
                    await this.connectWebSocket();
                    return true;
                } catch (error) {
                    console.error(`Failed to connect to ${this.channelName}:`, error);
                    this.scheduleReconnect();
                    throw error;
                }
            }

            async getChannelInfo() {
                try {
                    const channelResponse = await fetch(`${this.baseUrl}/v1/channels/${this.channelName}`, {
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });

                    if (!channelResponse.ok) {
                        throw new Error(`Channel ${this.channelName} not found (${channelResponse.status})`);
                    }

                    const channelData = await channelResponse.json();
                    this.channelId = channelData.id;
                    this.chatroomId = channelData.chatroom?.id;

                    if (!this.chatroomId) {
                        throw new Error(`No chatroom found for channel ${this.channelName}`);
                    }

                    console.log(`Channel ID: ${this.channelId}, Chatroom ID: ${this.chatroomId}`);
                    return true;
                    
                } catch (error) {
                    console.error(`Failed to get channel info:`, error);
                    throw error;
                }
            }

            async connectWebSocket() {
                return new Promise((resolve, reject) => {
                    try {
                        const wsUrl = `wss://ws-${this.pusherCluster}.pusher.com/app/${this.pusherAppKey}?protocol=${this.protocolVersion}&client=js&version=7.6.0&flash=false`;
                        
                        this.websocket = new WebSocket(wsUrl);
                        
                        this.websocket.onopen = () => {
                            console.log(`WebSocket connected`);
                            this.isConnected = true;
                            this.reconnectAttempts = 0;
                            this.updateWebSocketStatus('Connected');
                            
                            this.subscribeToChatroom();
                            this.startHeartbeat();
                            
                            this.emit('connected');
                            resolve();
                        };

                        this.websocket.onmessage = (event) => {
                            this.handleWebSocketMessage(event.data);
                        };

                        this.websocket.onclose = (event) => {
                            console.warn(`WebSocket closed: ${event.code} - ${event.reason}`);
                            this.isConnected = false;
                            this.updateWebSocketStatus('Disconnected');
                            this.stopHeartbeat();
                            this.emit('disconnected');
                            
                            if (event.code !== 1000) {
                                this.scheduleReconnect();
                            }
                        };

                        this.websocket.onerror = (error) => {
                            console.error(`WebSocket error:`, error);
                            this.isConnected = false;
                            this.updateWebSocketStatus('Error');
                            reject(error);
                        };

                    } catch (error) {
                        console.error(`Failed to create WebSocket connection:`, error);
                        reject(error);
                    }
                });
            }

            subscribeToChatroom() {
                if (!this.websocket || !this.chatroomId) {
                    console.error(`Cannot subscribe: WebSocket or chatroom ID missing`);
                    return;
                }

                const subscribeFormats = [
                    `chatrooms.${this.chatroomId}.v2`,
                    `chatrooms.${this.chatroomId}`,
                ];
                
                subscribeFormats.forEach(format => {
                    const subscribeMessage = {
                        event: 'pusher:subscribe',
                        data: {
                            channel: format
                        }
                    };

                    this.websocket.send(JSON.stringify(subscribeMessage));
                });
                
                this.updateWebSocketStatus('Subscribed');
            }

            handleWebSocketMessage(data) {
                try {
                    const message = JSON.parse(data);
                    
                    switch (message.event) {
                        case 'pusher:connection_established':
                            this.emit('pusher_connected');
                            break;

                        case 'pusher:subscription_succeeded':
                        case 'pusher_internal:subscription_succeeded':
                            this.emit('subscribed');
                            break;

                        case 'pusher:ping':
                            this.websocket.send(JSON.stringify({ event: 'pusher:pong', data: {} }));
                            break;

                        case 'pusher:pong':
                            this.lastPong = Date.now();
                            break;

                        case 'App\\Events\\ChatMessageEvent':
                            this.handleChatMessage(message);
                            break;

                        case 'pusher:error':
                            console.error(`Pusher error:`, message.data);
                            break;
                    }

                } catch (error) {
                    console.error(`Failed to parse WebSocket message:`, error, data);
                }
            }

            handleChatMessage(pusherMessage) {
                try {
                    const messageData = typeof pusherMessage.data === 'string' 
                        ? JSON.parse(pusherMessage.data) 
                        : pusherMessage.data;

                    const chatMessage = {
                        id: messageData.id,
                        username: messageData.sender.username,
                        message: messageData.content,
                        timestamp: new Date(messageData.created_at),
                        userId: messageData.sender.id,
                        userColor: messageData.sender.identity?.color || '#ffffff',
                        badges: messageData.sender.identity?.badges || [],
                        chatroomId: messageData.chatroom_id,
                        userType: this.getUserType(messageData.sender.identity?.badges || [])
                    };

                    if (this.messageCache.has(chatMessage.id)) {
                        return;
                    }

                    this.messageCache.add(chatMessage.id);
                    if (this.messageCache.size > 100) {
                        const firstItem = this.messageCache.values().next().value;
                        this.messageCache.delete(firstItem);
                    }

                    if (chatMessage.message && chatMessage.message.trim()) {
                        this.emit('message', chatMessage);

                        if (chatMessage.message.startsWith('!')) {
                            this.handleCommand(chatMessage);
                        }
                    }

                } catch (error) {
                    console.error(`Failed to handle chat message:`, error, pusherMessage);
                }
            }

            getUserType(badges) {
                if (badges.some(badge => badge.type === 'broadcaster')) return 'broadcaster';
                if (badges.some(badge => badge.type === 'moderator')) return 'moderator';
                if (badges.some(badge => badge.type === 'vip')) return 'vip';
                return 'viewer';
            }

            handleCommand(chatMessage) {
                const parts = chatMessage.message.trim().split(' ');
                const command = parts[0].toLowerCase();
                const args = parts.slice(1);

                const commandData = {
                    command: command,
                    args: args,
                    user: chatMessage.username,
                    userId: chatMessage.userId,
                    userType: chatMessage.userType,
                    fullMessage: chatMessage.message,
                    timestamp: chatMessage.timestamp,
                    userColor: chatMessage.userColor,
                    badges: chatMessage.badges
                };

                this.emit('command', commandData);
            }

            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    if (this.websocket && this.isConnected) {
                        if (Date.now() - this.lastPong > 60000) {
                            console.warn(`Heartbeat timeout, reconnecting...`);
                            this.websocket.close();
                            return;
                        }

                        this.websocket.send(JSON.stringify({
                            event: 'pusher:ping',
                            data: {}
                        }));
                    }
                }, 30000);
            }

            stopHeartbeat() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
            }

            scheduleReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.error(`Max reconnection attempts reached (${this.maxReconnectAttempts})`);
                    this.emit('error', new Error('Max reconnection attempts reached'));
                    return;
                }

                this.reconnectAttempts++;
                const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
                
                setTimeout(() => {
                    this.connect();
                }, delay);
            }

            updateWebSocketStatus(status) {
                const statusElement = document.getElementById('websocketState');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }

            on(event, callback) {
                if (!this.eventHandlers.has(event)) {
                    this.eventHandlers.set(event, []);
                }
                this.eventHandlers.get(event).push(callback);
            }

            emit(event, data = null) {
                if (this.eventHandlers.has(event)) {
                    this.eventHandlers.get(event).forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            console.error(`Error in event handler for ${event}:`, error);
                        }
                    });
                }
            }

            disconnect() {
                if (this.websocket) {
                    this.websocket.close(1000, 'Normal closure');
                }
                
                this.stopHeartbeat();
                this.isConnected = false;
                this.messageCache.clear();
                this.updateWebSocketStatus('Disconnected');
            }
        }

        // User Avatar System
        class UserAvatar {
            constructor(userId, username, userType) {
                this.userId = userId;
                this.username = username;
                this.userType = userType;
                this.position = this.getRandomPosition();
                this.currentEmoji = 0;
                this.emojis = ['ðŸŽ®', 'ðŸ¦¸', 'ðŸ¤–', 'ðŸ‘½', 'ðŸ‰', 'ðŸ¦„', 'âš¡', 'ðŸ”¥', 'ðŸ’Ž', 'ðŸŒŸ', 'ðŸŽ¯', 'ðŸš€', 'ðŸ¦Š', 'ðŸº', 'ðŸ¦', 'ðŸ¯', 'ðŸ»', 'ðŸ¼', 'ðŸ¦', 'ðŸ¦˜', 'ðŸ¦‹', 'ðŸ¸', 'ðŸ¦†', 'ðŸ§', 'ðŸ¦€'];
                this.isMoving = false;
                this.lastActivity = Date.now();
                
                this.createElement();
                this.createLabel();
            }

            getRandomPosition() {
                const safeMargin = 100;
                return {
                    x: safeMargin + Math.random() * (1920 - 2 * safeMargin - 60),
                    y: safeMargin + Math.random() * (1080 - 2 * safeMargin - 60)
                };
            }

            createElement() {
                this.element = document.createElement('div');
                this.element.className = 'user-avatar';
                this.element.textContent = this.emojis[this.currentEmoji];
                this.element.style.left = this.position.x + 'px';
                this.element.style.top = this.position.y + 'px';
                this.element.id = `avatar-${this.userId}`;
                
                document.body.appendChild(this.element);
            }

            createLabel() {
                this.label = document.createElement('div');
                this.label.className = `user-label ${this.userType}`;
                this.label.textContent = this.username;
                this.label.style.left = (this.position.x + 5) + 'px';
                this.label.style.top = (this.position.y - 15) + 'px';
                this.label.id = `label-${this.userId}`;
                
                document.body.appendChild(this.label);
            }

            updatePosition() {
                this.element.style.left = this.position.x + 'px';
                this.element.style.top = this.position.y + 'px';
                
                this.label.style.left = (this.position.x + 5) + 'px';
                this.label.style.top = (this.position.y - 15) + 'px';
            }

            async moveRight() {
                if (this.isMoving) return;
                this.isMoving = true;
                
                this.position.x = Math.min(1860, this.position.x + 80);
                this.element.classList.add('moving');
                this.updatePosition();
                
                setTimeout(() => {
                    this.element.classList.remove('moving');
                    this.isMoving = false;
                }, 300);
            }

            async moveLeft() {
                if (this.isMoving) return;
                this.isMoving = true;
                
                this.position.x = Math.max(0, this.position.x - 80);
                this.element.classList.add('moving');
                this.updatePosition();
                
                setTimeout(() => {
                    this.element.classList.remove('moving');
                    this.isMoving = false;
                }, 300);
            }

            async moveUp() {
                if (this.isMoving) return;
                this.isMoving = true;
                
                this.position.y = Math.max(0, this.position.y - 80);
                this.element.classList.add('moving');
                this.updatePosition();
                
                setTimeout(() => {
                    this.element.classList.remove('moving');
                    this.isMoving = false;
                }, 300);
            }

            async moveDown() {
                if (this.isMoving) return;
                this.isMoving = true;
                
                this.position.y = Math.min(1020, this.position.y + 80);
                this.element.classList.add('moving');
                this.updatePosition();
                
                setTimeout(() => {
                    this.element.classList.remove('moving');
                    this.isMoving = false;
                }, 300);
            }

            async dance() {
                this.element.classList.add('dancing');
                setTimeout(() => {
                    this.element.classList.remove('dancing');
                }, 1500);
            }

            async jump() {
                this.element.classList.add('jumping');
                setTimeout(() => {
                    this.element.classList.remove('jumping');
                }, 1000);
            }

            async spin() {
                this.element.classList.add('spinning');
                setTimeout(() => {
                    this.element.classList.remove('spinning');
                }, 1000);
            }

            changeAvatar() {
                this.currentEmoji = (this.currentEmoji + 1) % this.emojis.length;
                this.element.textContent = this.emojis[this.currentEmoji];
                
                // Enhanced animation for character change
                this.element.style.transition = 'all 0.3s ease-in-out';
                this.element.style.transform = 'scale(1.5) rotate(360deg)';
                this.element.style.filter = 'brightness(1.5) drop-shadow(0 0 15px rgba(255,255,255,0.8))';
                
                setTimeout(() => {
                    this.element.style.transform = 'scale(1) rotate(0deg)';
                    this.element.style.filter = 'drop-shadow(0 0 8px rgba(255,255,255,0.3))';
                    setTimeout(() => {
                        this.element.style.transition = 'all 0.3s ease';
                    }, 100);
                }, 300);
            }

            showSpeechBubble(message, isCommand = false) {
                // Remove existing bubble
                this.removeSpeechBubble();
                
                this.speechBubble = document.createElement('div');
                this.speechBubble.className = `speech-bubble ${this.userType}`;
                if (isCommand) this.speechBubble.classList.add('command');
                
                this.speechBubble.textContent = message;
                this.speechBubble.style.left = (this.position.x - 50) + 'px';
                this.speechBubble.style.top = (this.position.y - 60) + 'px';
                this.speechBubble.id = `bubble-${this.userId}`;
                
                document.body.appendChild(this.speechBubble);
                
                // Auto remove after 4 seconds
                setTimeout(() => {
                    this.removeSpeechBubble();
                }, 4000);
            }

            removeSpeechBubble() {
                if (this.speechBubble && this.speechBubble.parentNode) {
                    this.speechBubble.remove();
                    this.speechBubble = null;
                }
            }

            updateActivity() {
                this.lastActivity = Date.now();
            }

            isInactive() {
                return Date.now() - this.lastActivity > 300000; // 5 minutes
            }

            destroy() {
                this.removeSpeechBubble();
                if (this.element && this.element.parentNode) {
                    this.element.remove();
                }
                if (this.label && this.label.parentNode) {
                    this.label.remove();
                }
            }
        }

        // Multi-User Avatar Manager
        class MultiUserAvatarManager {
            constructor() {
                this.users = new Map();
                this.effects = new Map();
                this.cooldowns = new Map();
                this.soundEnabled = true;
                this.initializeEffects();
                
                // Cleanup inactive users every minute
                setInterval(() => {
                    this.cleanupInactiveUsers();
                }, 60000);
            }

            initializeEffects() {
                // Movement commands - per user
                this.effects.set('!saÄŸ', {
                    name: 'SaÄŸa Hareket',
                    cooldown: 1000,
                    action: 'moveRight',
                    isMovement: true
                });

                this.effects.set('!sol', {
                    name: 'Sola Hareket',
                    cooldown: 1000,
                    action: 'moveLeft',
                    isMovement: true
                });

                this.effects.set('!yukarÄ±', {
                    name: 'YukarÄ± Hareket',
                    cooldown: 1000,
                    action: 'moveUp',
                    isMovement: true
                });

                this.effects.set('!aÅŸaÄŸÄ±', {
                    name: 'AÅŸaÄŸÄ± Hareket',
                    cooldown: 1000,
                    action: 'moveDown',
                    isMovement: true
                });

                this.effects.set('!dans', {
                    name: 'Dans',
                    cooldown: 2000,
                    action: 'dance',
                    isMovement: true
                });

                this.effects.set('!zÄ±pla', {
                    name: 'ZÄ±plama',
                    cooldown: 1500,
                    action: 'jump',
                    isMovement: true
                });

                this.effects.set('!dÃ¶ndÃ¼r', {
                    name: 'DÃ¶nme',
                    cooldown: 1500,
                    action: 'spin',
                    isMovement: true
                });

                this.effects.set('!karakter', {
                    name: 'Karakter DeÄŸiÅŸtir',
                    cooldown: 3000,
                    action: 'changeAvatar',
                    isMovement: true
                });

                // Global effects
                this.effects.set('!patlama', {
                    name: 'Patlama Efekti',
                    cooldown: 4000,
                    action: 'createExplosion',
                    isGlobal: true
                });

                this.effects.set('!yÄ±ldÄ±rÄ±m', {
                    name: 'ÅžimÅŸek Ã‡akmasÄ±',
                    cooldown: 3000,
                    action: 'createLightning',
                    isGlobal: true
                });

                this.effects.set('!kar', {
                    name: 'Kar YaÄŸÄ±ÅŸÄ±',
                    cooldown: 6000,
                    action: 'createSnow',
                    isGlobal: true
                });

                this.effects.set('!ateÅŸ', {
                    name: 'AteÅŸ Ã‡emberi',
                    cooldown: 4000,
                    action: 'createFire',
                    isGlobal: true
                });

                this.effects.set('!konfeti', {
                    name: 'Konfeti PatlamasÄ±',
                    cooldown: 5000,
                    action: 'createConfetti',
                    isGlobal: true
                });

                this.effects.set('!kalp', {
                    name: 'Kalp YaÄŸmuru',
                    cooldown: 3000,
                    action: 'createHearts',
                    isGlobal: true
                });

                this.effects.set('!rainbow', {
                    name: 'GÃ¶kkuÅŸaÄŸÄ±',
                    cooldown: 7000,
                    action: 'createRainbow',
                    isGlobal: true
                });

                this.effects.set('!shake', {
                    name: 'Ekran SarsÄ±ntÄ±sÄ±',
                    cooldown: 5000,
                    action: 'createShake',
                    isGlobal: true
                });

                // Advanced Effects
                this.effects.set('!lazer', {
                    name: 'Lazer GÃ¶sterisi',
                    cooldown: 6000,
                    action: 'createLazer',
                    isGlobal: true
                });

                this.effects.set('!meteor', {
                    name: 'Meteor YaÄŸmuru',
                    cooldown: 8000,
                    action: 'createMeteor',
                    isGlobal: true
                });

                this.effects.set('!matrix', {
                    name: 'Matrix Efekti',
                    cooldown: 10000,
                    action: 'createMatrix',
                    isGlobal: true
                });

                this.effects.set('!portal', {
                    name: 'Portal AÃ§ma',
                    cooldown: 8000,
                    action: 'createPortal',
                    isGlobal: true
                });

                this.effects.set('!galaksi', {
                    name: 'Galaksi DÃ¶ndÃ¼rme',
                    cooldown: 12000,
                    action: 'createGalaxy',
                    isGlobal: true
                });

                this.effects.set('!tsunami', {
                    name: 'Tsunami DalgasÄ±',
                    cooldown: 15000,
                    action: 'createTsunami',
                    isGlobal: true
                });

                // Sound Effects
                this.effects.set('!bas', {
                    name: 'Bass Drop',
                    cooldown: 8000,
                    action: 'createBassDrop',
                    isGlobal: true
                });

                this.effects.set('!davul', {
                    name: 'Davul Ã‡alma',
                    cooldown: 3000,
                    action: 'createDrums',
                    isGlobal: true
                });

                this.effects.set('!gitar', {
                    name: 'Gitar Riffi',
                    cooldown: 5000,
                    action: 'createGuitar',
                    isGlobal: true
                });

                this.effects.set('!synth', {
                    name: 'Synthesizer',
                    cooldown: 4000,
                    action: 'createSynth',
                    isGlobal: true
                });

                // Special Effects
                this.effects.set('!nuke', {
                    name: 'NÃ¼kleer Patlama',
                    cooldown: 20000,
                    action: 'createNuke',
                    isGlobal: true
                });

                this.effects.set('!disco', {
                    name: 'Disco Topu',
                    cooldown: 7000,
                    action: 'createDisco',
                    isGlobal: true
                });

                this.effects.set('!ufo', {
                    name: 'UFO Ã‡aÄŸÄ±rma',
                    cooldown: 9000,
                    action: 'createUFO',
                    isGlobal: true
                });

                this.effects.set('!ninja', {
                    name: 'Ninja SaldÄ±rÄ±sÄ±',
                    cooldown: 6000,
                    action: 'createNinja',
                    isGlobal: true
                });
            }

            getOrCreateUser(userId, username, userType) {
                if (!this.users.has(userId)) {
                    const user = new UserAvatar(userId, username, userType);
                    this.users.set(userId, user);
                    console.log(`Created new avatar for ${username}`);
                }
                
                const user = this.users.get(userId);
                user.updateActivity();
                return user;
            }

            handleMessage(messageData) {
                const user = this.getOrCreateUser(
                    messageData.userId, 
                    messageData.username, 
                    messageData.userType
                );
                
                // Show speech bubble for all messages
                user.showSpeechBubble(messageData.message, messageData.message.startsWith('!'));
            }

            async handleCommand(commandData) {
                const { command, userId, user: username, userType } = commandData;
                
                if (!this.effects.has(command)) {
                    return false;
                }

                const effect = this.effects.get(command);
                const cooldownKey = `${userId}_${command}`;
                
                if (this.isOnCooldown(cooldownKey)) {
                    return false;
                }

                this.setCooldown(cooldownKey, effect.cooldown);
                
                try {
                    if (effect.isMovement) {
                        // User-specific avatar action
                        const userAvatar = this.getOrCreateUser(userId, username, userType);
                        await userAvatar[effect.action]();
                        
                        this.showMiniNotification(`${username}: ${effect.name}`);
                    } else if (effect.isGlobal) {
                        // Global screen effect
                        await this[effect.action]();
                        this.showMiniNotification(`${username} used ${effect.name}`);
                    }
                    
                    this.playSimpleSound();
                    return true;
                } catch (error) {
                    console.error(`Error executing effect ${command}:`, error);
                    return false;
                }
            }

            showMiniNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'mini-effect-notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 2000);
            }

            cleanupInactiveUsers() {
                for (const [userId, user] of this.users.entries()) {
                    if (user.isInactive()) {
                        console.log(`Removing inactive user: ${user.username}`);
                        user.destroy();
                        this.users.delete(userId);
                    }
                }
                
                this.updateUserCount();
            }

            updateUserCount() {
                document.getElementById('activeAvatars').textContent = this.users.size;
                document.getElementById('totalAvatars').textContent = this.users.size;
            }

            // Global Effects
            async createExplosion() {
                const explosion = document.createElement('div');
                explosion.innerHTML = 'ðŸ’¥';
                explosion.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 80px;
                    z-index: 10000;
                    pointer-events: none;
                    filter: drop-shadow(0 0 20px #ff4444);
                `;

                document.body.appendChild(explosion);

                explosion.animate([
                    { fontSize: '80px', opacity: 1, transform: 'translate(-50%, -50%) scale(0.3)' },
                    { fontSize: '250px', opacity: 0.9, transform: 'translate(-50%, -50%) scale(2.5)' },
                    { fontSize: '400px', opacity: 0, transform: 'translate(-50%, -50%) scale(4)' }
                ], {
                    duration: 2500,
                    easing: 'ease-out'
                });

                this.createParticles('ðŸ”¥', 20, 2500);

                setTimeout(() => {
                    explosion.remove();
                }, 2500);
            }

            async createLightning() {
                const flash = document.createElement('div');
                flash.className = 'lightning-flash';
                flash.style.animation = 'lightningFlash 1.8s ease-out forwards';
                document.body.appendChild(flash);

                setTimeout(() => {
                    flash.remove();
                }, 1800);
            }

            async createSnow() {
                const container = document.getElementById('particlesContainer');
                
                for (let i = 0; i < 60; i++) {
                    const snowflake = document.createElement('div');
                    snowflake.innerHTML = Math.random() > 0.5 ? 'â„ï¸' : 'ðŸŒ¨ï¸';
                    snowflake.className = 'particle';
                    snowflake.style.cssText = `
                        left: ${Math.random() * 100}vw;
                        top: -50px;
                        font-size: ${Math.random() * 20 + 10}px;
                        animation: particleFloat ${Math.random() * 3 + 2}s linear forwards;
                        animation-delay: ${Math.random() * 2}s;
                    `;
                    container.appendChild(snowflake);

                    setTimeout(() => {
                        snowflake.remove();
                    }, 5000);
                }
            }

            async createFire() {
                this.createParticles('ðŸ”¥', 20, 3000);
            }

            async createConfetti() {
                const emojis = ['ðŸŽ‰', 'ðŸŽŠ', 'âœ¨', 'ðŸŒŸ', 'ðŸŽˆ'];
                emojis.forEach(emoji => {
                    this.createParticles(emoji, 8, 2500);
                });
            }

            async createHearts() {
                const hearts = ['ðŸ’–', 'ðŸ’•', 'ðŸ’—', 'ðŸ’'];
                hearts.forEach(heart => {
                    this.createParticles(heart, 6, 2000);
                });
            }

            async createRainbow() {
                const rainbow = document.createElement('div');
                rainbow.innerHTML = 'ðŸŒˆ';
                rainbow.style.cssText = `
                    position: fixed;
                    top: 30%;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 100px;
                    z-index: 10000;
                    pointer-events: none;
                    filter: drop-shadow(0 0 20px #ff69b4);
                `;
                document.body.appendChild(rainbow);

                rainbow.animate([
                    { transform: 'translateX(-50%) translateY(-100px) scale(0)', opacity: 0 },
                    { transform: 'translateX(-50%) translateY(0) scale(1)', opacity: 1 },
                    { transform: 'translateX(-50%) translateY(100px) scale(0)', opacity: 0 }
                ], {
                    duration: 3500,
                    easing: 'ease-in-out'
                });

                this.createParticles('âœ¨', 10, 3000);

                setTimeout(() => {
                    rainbow.remove();
                }, 3500);
            }

            async createShake() {
                document.body.classList.add('screen-shake');
                setTimeout(() => {
                    document.body.classList.remove('screen-shake');
                }, 1000);
            }

            // Advanced Visual Effects
            async createLazer() {
                const lazer = document.createElement('div');
                lazer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 50%;
                    width: 10px;
                    height: 100vh;
                    background: linear-gradient(180deg, transparent, #ff0080, #00ff80, #0080ff, transparent);
                    transform: translateX(-50%);
                    z-index: 10000;
                    box-shadow: 0 0 20px #ff0080, 0 0 40px #00ff80, 0 0 60px #0080ff;
                    animation: lazerSweep 3s ease-in-out;
                `;
                
                document.body.appendChild(lazer);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes lazerSweep {
                        0% { left: 0%; opacity: 0; }
                        20% { left: 25%; opacity: 1; }
                        50% { left: 50%; opacity: 1; }
                        80% { left: 75%; opacity: 1; }
                        100% { left: 100%; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    lazer.remove();
                    style.remove();
                }, 3000);
            }

            async createMeteor() {
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        const meteor = document.createElement('div');
                        meteor.textContent = 'â˜„ï¸';
                        meteor.style.cssText = `
                            position: fixed;
                            top: -50px;
                            left: ${Math.random() * 100}vw;
                            font-size: ${30 + Math.random() * 40}px;
                            z-index: 10000;
                            animation: meteorFall ${2 + Math.random() * 2}s linear forwards;
                            filter: drop-shadow(0 0 10px #ff4400);
                        `;
                        
                        document.body.appendChild(meteor);
                        
                        setTimeout(() => {
                            meteor.remove();
                        }, 4000);
                    }, i * 400);
                }
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes meteorFall {
                        0% { transform: translateY(-50px) rotate(45deg); opacity: 1; }
                        100% { transform: translateY(1130px) rotate(45deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => style.remove(), 5000);
            }

            async createMatrix() {
                const matrixOverlay = document.createElement('div');
                matrixOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    overflow: hidden;
                `;
                
                document.body.appendChild(matrixOverlay);
                
                const characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
                
                for (let i = 0; i < 50; i++) {
                    const column = document.createElement('div');
                    column.style.cssText = `
                        position: absolute;
                        top: -100px;
                        left: ${Math.random() * 100}vw;
                        color: #00ff00;
                        font-family: 'Courier New', monospace;
                        font-size: 16px;
                        animation: matrixRain ${3 + Math.random() * 3}s linear infinite;
                        text-shadow: 0 0 5px #00ff00;
                    `;
                    
                    let text = '';
                    for (let j = 0; j < 20; j++) {
                        text += characters.charAt(Math.floor(Math.random() * characters.length)) + '<br>';
                    }
                    column.innerHTML = text;
                    
                    matrixOverlay.appendChild(column);
                }
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes matrixRain {
                        0% { transform: translateY(-100px); opacity: 1; }
                        100% { transform: translateY(1180px); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    matrixOverlay.remove();
                    style.remove();
                }, 5000);
            }

            async createPortal() {
                const portal = document.createElement('div');
                portal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 200px;
                    height: 200px;
                    border-radius: 50%;
                    background: radial-gradient(circle, #8000ff 0%, #4000ff 30%, #0080ff 70%, transparent 100%);
                    transform: translate(-50%, -50%);
                    z-index: 10000;
                    animation: portalSpin 4s linear forwards;
                    box-shadow: 0 0 50px #8000ff, 0 0 100px #4000ff;
                `;
                
                document.body.appendChild(portal);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes portalSpin {
                        0% { transform: translate(-50%, -50%) rotate(0deg) scale(0); opacity: 0; }
                        25% { transform: translate(-50%, -50%) rotate(90deg) scale(1); opacity: 1; }
                        75% { transform: translate(-50%, -50%) rotate(270deg) scale(1); opacity: 1; }
                        100% { transform: translate(-50%, -50%) rotate(360deg) scale(0); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    portal.remove();
                    style.remove();
                }, 4000);
            }

            async createGalaxy() {
                const galaxy = document.createElement('div');
                galaxy.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 400px;
                    height: 400px;
                    border-radius: 50%;
                    background: radial-gradient(ellipse at center, #ffffff 0%, #8000ff 25%, #4000ff 50%, #000040 75%, transparent 100%);
                    transform: translate(-50%, -50%);
                    z-index: 10000;
                    animation: galaxySpin 6s ease-in-out forwards;
                    box-shadow: 0 0 100px #8000ff;
                `;
                
                document.body.appendChild(galaxy);
                
                // Add stars
                for (let i = 0; i < 30; i++) {
                    const star = document.createElement('div');
                    star.textContent = 'â­';
                    star.style.cssText = `
                        position: absolute;
                        top: ${Math.random() * 400}px;
                        left: ${Math.random() * 400}px;
                        font-size: ${10 + Math.random() * 20}px;
                        animation: starTwinkle ${1 + Math.random() * 2}s ease-in-out infinite alternate;
                    `;
                    galaxy.appendChild(star);
                }
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes galaxySpin {
                        0% { transform: translate(-50%, -50%) rotate(0deg) scale(0); opacity: 0; }
                        20% { transform: translate(-50%, -50%) rotate(72deg) scale(0.8); opacity: 1; }
                        80% { transform: translate(-50%, -50%) rotate(288deg) scale(1.2); opacity: 1; }
                        100% { transform: translate(-50%, -50%) rotate(360deg) scale(0); opacity: 0; }
                    }
                    @keyframes starTwinkle {
                        0% { opacity: 0.3; transform: scale(0.8); }
                        100% { opacity: 1; transform: scale(1.2); }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    galaxy.remove();
                    style.remove();
                }, 6000);
            }

            async createTsunami() {
                const waves = document.createElement('div');
                waves.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: -100vw;
                    width: 300vw;
                    height: 200px;
                    background: linear-gradient(0deg, #0066cc 0%, #0099ff 50%, #66ccff 100%);
                    z-index: 10000;
                    animation: tsunamiWave 8s ease-in-out forwards;
                    opacity: 0.8;
                `;
                
                document.body.appendChild(waves);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes tsunamiWave {
                        0% { left: -300vw; height: 50px; }
                        30% { left: -50vw; height: 150px; }
                        50% { left: 0vw; height: 200px; }
                        70% { left: 50vw; height: 150px; }
                        100% { left: 300vw; height: 50px; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    waves.remove();
                    style.remove();
                }, 8000);
            }

            // Sound Effects
            async createBassDrop() {
                document.body.style.animation = 'screenShake 0.5s ease-in-out 6';
                this.createParticles('ðŸ”Š', 15, 3000);
                
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 3000);
            }

            async createDrums() {
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const drumHit = document.createElement('div');
                        drumHit.textContent = 'ðŸ¥';
                        drumHit.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-size: 60px;
                            z-index: 10000;
                            animation: drumPulse 0.3s ease-out forwards;
                        `;
                        
                        document.body.appendChild(drumHit);
                        
                        setTimeout(() => {
                            drumHit.remove();
                        }, 300);
                    }, i * 250);
                }
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes drumPulse {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                        50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
                        100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => style.remove(), 2500);
            }

            async createGuitar() {
                this.createParticles('ðŸŽ¸', 10, 3000);
                
                const guitar = document.createElement('div');
                guitar.textContent = 'ðŸŽ¸';
                guitar.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 80px;
                    z-index: 10000;
                    animation: guitarRiff 2s ease-in-out forwards;
                `;
                
                document.body.appendChild(guitar);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes guitarRiff {
                        0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
                        25% { transform: translate(-50%, -50%) rotate(-15deg) scale(1.2); }
                        50% { transform: translate(-50%, -50%) rotate(15deg) scale(1.1); }
                        75% { transform: translate(-50%, -50%) rotate(-10deg) scale(1.2); }
                        100% { transform: translate(-50%, -50%) rotate(0deg) scale(0); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    guitar.remove();
                    style.remove();
                }, 2000);
            }

            async createSynth() {
                this.createParticles('ðŸŽ¹', 12, 2500);
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const wave = document.createElement('div');
                        wave.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            width: 100px;
                            height: 100px;
                            border: 3px solid #00ffff;
                            border-radius: 50%;
                            transform: translate(-50%, -50%);
                            z-index: 10000;
                            animation: synthWave 1s ease-out forwards;
                        `;
                        
                        document.body.appendChild(wave);
                        
                        setTimeout(() => {
                            wave.remove();
                        }, 1000);
                    }, i * 200);
                }
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes synthWave {
                        0% { width: 50px; height: 50px; opacity: 1; }
                        100% { width: 300px; height: 300px; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => style.remove(), 2000);
            }

            // Special Effects
            async createNuke() {
                const flash = document.createElement('div');
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: radial-gradient(circle, #ffffff 0%, #ffff00 30%, #ff4400 70%, #000000 100%);
                    z-index: 10000;
                    animation: nukeFlash 3s ease-out forwards;
                `;
                
                document.body.appendChild(flash);
                
                setTimeout(() => {
                    this.createParticles('ðŸ’¥', 30, 5000);
                    this.createParticles('â˜¢ï¸', 10, 5000);
                }, 1000);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes nukeFlash {
                        0% { opacity: 0; }
                        10% { opacity: 1; }
                        30% { opacity: 0.8; }
                        100% { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    flash.remove();
                    style.remove();
                }, 3000);
            }

            async createDisco() {
                const discoBall = document.createElement('div');
                discoBall.textContent = 'ðŸª©';
                discoBall.style.cssText = `
                    position: fixed;
                    top: 20%;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 80px;
                    z-index: 10000;
                    animation: discoSpin 4s linear forwards;
                    filter: drop-shadow(0 0 20px #ffffff);
                `;
                
                document.body.appendChild(discoBall);
                
                // Create disco lights
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const light = document.createElement('div');
                        light.style.cssText = `
                            position: fixed;
                            top: ${Math.random() * 100}vh;
                            left: ${Math.random() * 100}vw;
                            width: 20px;
                            height: 20px;
                            background: ${['#ff0080', '#00ff80', '#0080ff', '#ff8000'][Math.floor(Math.random() * 4)]};
                            border-radius: 50%;
                            z-index: 10000;
                            animation: discoLight 0.5s ease-out forwards;
                        `;
                        
                        document.body.appendChild(light);
                        
                        setTimeout(() => {
                            light.remove();
                        }, 500);
                    }, i * 100);
                }
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes discoSpin {
                        0% { transform: translateX(-50%) rotate(0deg) scale(1); }
                        100% { transform: translateX(-50%) rotate(1440deg) scale(0); }
                    }
                    @keyframes discoLight {
                        0% { opacity: 1; transform: scale(0); }
                        50% { opacity: 1; transform: scale(1.5); }
                        100% { opacity: 0; transform: scale(0); }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    discoBall.remove();
                    style.remove();
                }, 4000);
            }

            async createUFO() {
                const ufo = document.createElement('div');
                ufo.textContent = 'ðŸ›¸';
                ufo.style.cssText = `
                    position: fixed;
                    top: 30%;
                    left: -100px;
                    font-size: 60px;
                    z-index: 10000;
                    animation: ufoFly 5s ease-in-out forwards;
                    filter: drop-shadow(0 0 20px #00ff00);
                `;
                
                document.body.appendChild(ufo);
                
                this.createParticles('ðŸ‘½', 5, 3000);
                this.createParticles('âœ¨', 15, 4000);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes ufoFly {
                        0% { left: -100px; transform: translateY(0); }
                        25% { left: 25vw; transform: translateY(-20px); }
                        50% { left: 50vw; transform: translateY(20px); }
                        75% { left: 75vw; transform: translateY(-10px); }
                        100% { left: 100vw; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    ufo.remove();
                    style.remove();
                }, 5000);
            }

            async createNinja() {
                const ninja = document.createElement('div');
                ninja.textContent = 'ðŸ¥·';
                ninja.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 100vw;
                    font-size: 50px;
                    z-index: 10000;
                    animation: ninjaAttack 2s ease-in-out forwards;
                `;
                
                document.body.appendChild(ninja);
                
                setTimeout(() => {
                    this.createParticles('âš¡', 8, 1500);
                    this.createParticles('ðŸ’¨', 6, 1500);
                }, 800);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes ninjaAttack {
                        0% { left: 100vw; }
                        30% { left: 60vw; }
                        50% { left: 40vw; }
                        70% { left: 20vw; }
                        100% { left: -100px; }
                    }
                `;
                document.head.appendChild(style);
                
                setTimeout(() => {
                    ninja.remove();
                    style.remove();
                }, 2000);
            }

            createParticles(emoji, count, duration) {
                const container = document.getElementById('particlesContainer');
                
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.innerHTML = emoji;
                    particle.className = 'particle';
                    particle.style.cssText = `
                        position: absolute;
                        top: ${Math.random() * 100}vh;
                        left: ${Math.random() * 100}vw;
                        font-size: ${Math.random() * 25 + 15}px;
                        pointer-events: none;
                        z-index: 9999;
                        animation: particleFloat ${duration/1000}s ease-out forwards;
                        animation-delay: ${Math.random() * 500}ms;
                    `;

                    container.appendChild(particle);

                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, duration + 1000);
                }
            }

            playSimpleSound() {
                if (!this.soundEnabled) return;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    console.warn('Audio context error:', error);
                }
            }

            isOnCooldown(key) {
                const cooldown = this.cooldowns.get(key);
                if (!cooldown) return false;
                return Date.now() < cooldown;
            }

            setCooldown(key, duration) {
                this.cooldowns.set(key, Date.now() + duration);
            }

            getUserCount() {
                return this.users.size;
            }
        }

        // Main Application
        class MultiUserAvatarOverlay {
            constructor() {
                this.channelName = this.getChannelFromURL() || 'eyzaun';
                this.kickWebSocket = new EyzaunKickWebSocketAPI(this.channelName);
                this.avatarManager = new MultiUserAvatarManager();
                this.stats = {
                    totalMessages: 0,
                    totalMoves: 0,
                    startTime: Date.now()
                };
                
                this.init();
            }

            getChannelFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const channelParam = urlParams.get('channel');
                if (channelParam) {
                    return channelParam;
                }
                return null;
            }

            async init() {
                document.getElementById('channelName').textContent = this.channelName;

                // Event listeners
                this.kickWebSocket.on('connected', () => {
                    this.updateConnectionStatus(true);
                });

                this.kickWebSocket.on('subscribed', () => {
                    this.hideLoadingScreen();
                });

                this.kickWebSocket.on('message', (message) => {
                    this.handleMessage(message);
                });

                this.kickWebSocket.on('command', (command) => {
                    this.handleCommand(command);
                });

                this.kickWebSocket.on('error', (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus(false);
                });

                this.kickWebSocket.on('disconnected', () => {
                    this.updateConnectionStatus(false);
                });

                // Connect to WebSocket
                try {
                    await this.kickWebSocket.connect();
                } catch (error) {
                    console.error('Failed to connect:', error);
                    this.updateConnectionStatus(false);
                    
                    setTimeout(() => {
                        this.hideLoadingScreen();
                    }, 3000);
                }

                this.startStatsUpdater();
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                if (connected) {
                    statusEl.textContent = `MULTI-AVATAR SYSTEM ACTIVE`;
                    statusEl.style.borderColor = '#00ff00';
                } else {
                    statusEl.textContent = 'BaÄŸlantÄ± kuruluyor...';
                    statusEl.style.borderColor = '#ff0000';
                }
            }

            hideLoadingScreen() {
                document.getElementById('loadingScreen').classList.add('hidden');
            }

            handleMessage(message) {
                this.stats.totalMessages++;
                this.avatarManager.handleMessage(message);
                this.avatarManager.updateUserCount();
            }

            handleCommand(command) {
                if (this.avatarManager.handleCommand(command)) {
                    this.stats.totalMoves++;
                }
                this.avatarManager.updateUserCount();
            }

            startStatsUpdater() {
                setInterval(() => {
                    document.getElementById('totalMessages').textContent = this.stats.totalMessages;
                    document.getElementById('totalMoves').textContent = this.stats.totalMoves;
                    
                    const uptime = Math.floor((Date.now() - this.stats.startTime) / 1000);
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = uptime % 60;
                    
                    document.getElementById('uptime').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
        }

        // Initialize Multi-User Avatar System
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Multi-User Avatar System Starting...');
            console.log('Features: Individual user avatars, speech bubbles, movement commands');
            console.log('Each user controls their own avatar with movement and animation commands');
            console.log('Messages appear as speech bubbles above user avatars');
            console.log('Status: MULTI-AVATAR SYSTEM READY');
            new MultiUserAvatarOverlay();
        });

        // Global error handler
        window.addEventListener('error', (error) => {
            console.error('Multi-avatar system error:', error);
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            console.log('Multi-user avatar system loaded successfully');
            console.log('Target channel: eyzaun');
            console.log('Individual user avatar control active');
            console.log('Speech bubble system active');
            console.log('Status: FULLY OPERATIONAL');
        });
    </script>
</body>
</html>