<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kick WebSocket Debug Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        
        .debug-section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00ff00;
        }
        
        .error {
            border-left-color: #ff0000;
            color: #ff6666;
        }
        
        .warning {
            border-left-color: #ffaa00;
            color: #ffcc66;
        }
        
        .success {
            border-left-color: #00ff00;
            color: #66ff66;
        }
        
        .raw-message {
            background: #333;
            padding: 10px;
            margin: 5px 0;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #00ff00;
            color: #000;
        }
        
        #messageCount {
            color: #ffaa00;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Kick WebSocket Debug Test</h1>
    
    <div class="debug-section">
        <h3>Connection Status</h3>
        <div id="connectionStatus">Not connected</div>
        <div id="subscriptionStatus">Not subscribed</div>
        <div>Total Messages: <span id="messageCount">0</span></div>
    </div>
    
    <div class="debug-section">
        <h3>Tests</h3>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="testAlternativeChannels()">Test Alternative Channels</button>
        <button onclick="testDifferentEvents()">Listen All Events</button>
        <button onclick="sendTestPing()">Send Test Ping</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div class="debug-section">
        <h3>Raw Messages Log</h3>
        <div id="rawLog"></div>
    </div>
    
    <div class="debug-section">
        <h3>Parsed Chat Messages</h3>
        <div id="chatLog"></div>
    </div>

    <script>
        let websocket = null;
        let messageCount = 0;
        let allMessages = [];
        const channelName = 'eyzaun';
        const pusherAppKey = '32cbd69e4b950bf97679';
        const pusherCluster = 'us2';
        let channelId = null;
        let chatroomId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('rawLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            
            logDiv.innerHTML += `<div class="raw-message ${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function logChat(message) {
            const chatDiv = document.getElementById('chatLog');
            const timestamp = new Date().toLocaleTimeString();
            chatDiv.innerHTML += `<div class="raw-message success">[${timestamp}] CHAT: ${message}</div>`;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        function updateStatus(connection, subscription) {
            document.getElementById('connectionStatus').textContent = connection;
            document.getElementById('subscriptionStatus').textContent = subscription;
        }
        
        async function getChannelInfo() {
            try {
                log('Getting channel info...', 'info');
                const response = await fetch(`https://kick.com/api/v1/channels/${channelName}`);
                
                if (!response.ok) {
                    log(`Channel API error: ${response.status}`, 'error');
                    return false;
                }
                
                const data = await response.json();
                channelId = data.id;
                chatroomId = data.chatroom?.id;
                
                log(`Channel ID: ${channelId}, Chatroom ID: ${chatroomId}`, 'success');
                return true;
            } catch (error) {
                log(`Channel info error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testConnection() {
            log('Starting connection test...', 'info');
            
            if (!(await getChannelInfo())) {
                return;
            }
            
            const wsUrl = `wss://ws-${pusherCluster}.pusher.com/app/${pusherAppKey}?protocol=7&client=js&version=7.6.0&flash=false`;
            log(`Connecting to: ${wsUrl}`, 'info');
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = () => {
                log('WebSocket connected!', 'success');
                updateStatus('Connected', 'Not subscribed');
            };
            
            websocket.onmessage = (event) => {
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;
                
                try {
                    const message = JSON.parse(event.data);
                    allMessages.push(message);
                    
                    log(`RAW MESSAGE: ${JSON.stringify(message, null, 2)}`, 'info');
                    
                    // Handle specific events
                    switch (message.event) {
                        case 'pusher:connection_established':
                            log('Pusher connection established!', 'success');
                            subscribeToChatroom();
                            break;
                            
                        case 'pusher:subscription_succeeded':
                        case 'pusher_internal:subscription_succeeded':
                            log('Successfully subscribed!', 'success');
                            updateStatus('Connected', 'Subscribed');
                            break;
                            
                        case 'App\\Events\\ChatMessageSentEvent':
                            log('CHAT MESSAGE EVENT DETECTED!', 'success');
                            handleChatMessage(message);
                            break;
                            
                        default:
                            // Try to parse any message as potential chat
                            tryParseAnyMessage(message);
                            break;
                    }
                } catch (error) {
                    log(`Message parse error: ${error.message}`, 'error');
                    log(`Raw data: ${event.data}`, 'warning');
                }
            };
            
            websocket.onclose = (event) => {
                log(`WebSocket closed: ${event.code} - ${event.reason}`, 'warning');
                updateStatus('Disconnected', 'Not subscribed');
            };
            
            websocket.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
                updateStatus('Error', 'Not subscribed');
            };
        }
        
        function subscribeToChatroom() {
            if (!websocket || !chatroomId) {
                log('Cannot subscribe: missing websocket or chatroom ID', 'error');
                return;
            }
            
            // Test multiple subscription formats
            const subscribeFormats = [
                `chatrooms.${chatroomId}`,
                `chatrooms.${chatroomId}.v2`,
                `chat.${chatroomId}`,
                `channel.${channelId}`,
                `private-chatrooms.${chatroomId}`,
                `presence-chatrooms.${chatroomId}`
            ];
            
            subscribeFormats.forEach(format => {
                const subscribeMessage = {
                    event: 'pusher:subscribe',
                    data: {
                        channel: format
                    }
                };
                
                log(`Trying to subscribe to: ${format}`, 'info');
                websocket.send(JSON.stringify(subscribeMessage));
            });
        }
        
        function tryParseAnyMessage(pusherMessage) {
            try {
                // Check if this could be a chat message
                if (pusherMessage.data) {
                    let messageData;
                    if (typeof pusherMessage.data === 'string') {
                        try {
                            messageData = JSON.parse(pusherMessage.data);
                        } catch {
                            return;
                        }
                    } else {
                        messageData = pusherMessage.data;
                    }
                    
                    // Look for chat-like structure
                    if (messageData && (messageData.message || messageData.content) && (messageData.user || messageData.sender)) {
                        log('POTENTIAL CHAT MESSAGE FOUND!', 'success');
                        logChat(JSON.stringify(messageData, null, 2));
                        
                        const username = messageData.user?.username || messageData.sender?.username || 'Unknown';
                        const content = messageData.message?.message || messageData.message?.content || messageData.content || 'No content';
                        
                        logChat(`${username}: ${content}`);
                    }
                }
            } catch (error) {
                // Ignore parsing errors for non-chat messages
            }
        }
        
        function handleChatMessage(pusherMessage) {
            try {
                const messageData = typeof pusherMessage.data === 'string' 
                    ? JSON.parse(pusherMessage.data) 
                    : pusherMessage.data;
                
                const username = messageData.user?.username || 'Unknown';
                const content = messageData.message?.message || messageData.message?.content || 'No content';
                
                logChat(`${username}: ${content}`);
                
                if (content.startsWith('!')) {
                    log(`COMMAND DETECTED: ${content}`, 'success');
                }
            } catch (error) {
                log(`Chat message parse error: ${error.message}`, 'error');
            }
        }
        
        function testAlternativeChannels() {
            if (!websocket || !chatroomId) {
                log('WebSocket not connected', 'error');
                return;
            }
            
            // Test alternative channel names
            const alternativeChannels = [
                `chat-${chatroomId}`,
                `messages-${chatroomId}`,
                `room-${chatroomId}`,
                `kick-chat-${chatroomId}`,
                `live-chat-${chatroomId}`,
                `stream-${channelId}`,
                `channel-${channelId}-chat`
            ];
            
            alternativeChannels.forEach(channel => {
                const subscribeMessage = {
                    event: 'pusher:subscribe',
                    data: { channel: channel }
                };
                log(`Testing alternative channel: ${channel}`, 'info');
                websocket.send(JSON.stringify(subscribeMessage));
            });
        }
        
        function testDifferentEvents() {
            log('Now listening for ALL events - check console and logs', 'info');
            // The existing onmessage handler will catch all events
        }
        
        function sendTestPing() {
            if (!websocket) {
                log('WebSocket not connected', 'error');
                return;
            }
            
            const pingMessage = {
                event: 'pusher:ping',
                data: {}
            };
            
            websocket.send(JSON.stringify(pingMessage));
            log('Test ping sent', 'info');
        }
        
        function clearLogs() {
            document.getElementById('rawLog').innerHTML = '';
            document.getElementById('chatLog').innerHTML = '';
            messageCount = 0;
            allMessages = [];
            document.getElementById('messageCount').textContent = '0';
        }
        
        // Auto-start connection test
        document.addEventListener('DOMContentLoaded', () => {
            log('Debug tool loaded. Click "Test Connection" to start.', 'info');
        });
        
        // Add periodic status check
        setInterval(() => {
            if (websocket) {
                const state = websocket.readyState;
                const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                log(`WebSocket state: ${states[state]}`, state === 1 ? 'success' : 'warning');
            }
        }, 30000);
        
    </script>
</body>
</html>